# Copyright 2021 Amazon.com, Inc. or its affiliates. All Rights Reserved.
#
# Permission is hereby granted, free of charge, to any person obtaining a copy of this
# software and associated documentation files (the "Software"), to deal in the Software
# without restriction, including without limitation the rights to use, copy, modify,
# merge, publish, distribute, sublicense, and/or sell copies of the Software, and to
# permit persons to whom the Software is furnished to do so.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED,
# INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A
# PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
# HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
# OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
# SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
#
description: |-
  ### Document name - AWS-ExportPatchReportToS3

    ## What does this document do?
    This document retrieves lists of patch summary data and patch details in AWS Systems Manager Patch Manager and exports them to a CSV file in a specified Amazon S3 bucket.

    ## Input Parameters
    * assumeRole: The Amazon Resource Name (ARN) of the role that allows Automation to perform the actions on your behalf.
    * reportName: The name of the CSV report to generate and download to S3.
    * s3BucketName: The Amazon S3 bucket where you want to download the output file.
    * snsTopicArn: The Amazon Simple Notification Service (SNS) topic ARN to notify when the download completes.
    * snsSuccessMessage: The message to send when the export finishes. If you don't specify message text, the snsSuccessMessage is sent empty by default.
    * targets: The instance ID or a wildcard character (*) to indicate whether to report patch data for a specific instance or for all instances. Use the format: instanceids=i-12345678901234567 or instanceids=*. Currently, the format 'instanceids=instance1,instance2' is not supported.

    ## Output parameters
    * PatchSummary/Patches object: If the document runs successfully, the exported patch summary object or patches object is uploaded to your target S3 bucket.
schemaVersion: '0.3'
assumeRole: '{{assumeRole}}'
parameters:
  assumeRole:
    type: String
    description: (Required) The role ARN to assume during the automation.
    allowedPattern: '^arn:aws([a-zA-Z-]*)?:iam::d{12}:role/([a-zA-Z0-9_+=,.@/-]+)$'
  reportName:
    type: String
    allowedPattern: '^[a-zA-Z0-9._-]{1,50}$'
    description: (Required) The name of the CSV report to generate and download to S3.
  s3BucketName:
    type: String
    allowedPattern: '^[a-z0-9.-]{3,63}$'
    description: (Required) The Amazon S3 bucket where you want to download the output file.
  targets:
    type: String
    description: |-
      (Required) Instance ID or a wildcard character (*) to indicate whether to report patch data for a specific instance or for all instances. 
          Use the format 'instanceids=i-12345678901234567' or 'instanceids=*'. Currently, the format 'instanceids=instance1,instance2' is not supported.
    allowedPattern: '^instanceids=((i-(w{8}|w{17}))|(mi-w{17})|(*))$'
  snsTopicArn:
    type: String
    description: (Optional) The Amazon Simple Notification Service (SNS) topic ARN to notify when the download completes.
    allowedPattern: '^(arn:aws([a-zA-Z-]*)?:sns:[a-z]{2}((-gov)|(-iso(b?)))?-[a-z]+-d{1}:d{12}:[a-zA-Z0-9-_]{1,256})|(^$)$'
    default: ''
  snsSuccessMessage:
    type: String
    description: (Optional) The message to send when the process completes. The maximum size is 256kb.
    default: ''
mainSteps:
  - name: ExportReportStep
    action: 'aws:executeScript'
    outputs:
      - Name: Succeeded
        Selector: $.Payload
        Type: Boolean
    inputs:
      Runtime: python3.6
      Handler: script.script_handler
      Script: 'def hello(): return hello'
      InputPayload:
        ReportName: '{{reportName}}'
        S3BucketName: '{{s3BucketName}}'
        SnsTopicArn: '{{snsTopicArn}}'
        SnsSuccessMessage: '{{snsSuccessMessage}}'
        Targets: '{{targets}}'
      Attachment: AWS-ExportPatchReportToS3.zip
    description: |-
      ### What does the step do?
            The action for this step depends on the value of the 'targets' parameter. If 'targets' is in the format of 'instanceids=*',
            the step retrieves up to 10,000 patch summaries for instances in your account and exports the data to a CSV file.

            If 'targets' is in the format 'instanceids=<instance-id>',
            the step retrieves both the patch summary and all the patches for the specified instance in your account and exports them to a CSV file.

            ### What is the output of the step?
            The list of patch summaries/patches for all instances or for the specified instance is stored as a CSV file in an Amazon S3 bucket.
            An Amazon SNS message is published to report success. The output file name and the S3 bucket name are included in the message when the script finishes successfully.
    timeoutSeconds: 600
files:
  AWS-ExportPatchReportToS3.zip:
    checksums:
      sha256: 16f0affe3bc9b6ff126f767e888e436ed372e3340fb99e6e4cdccefb1a9cfc7a
